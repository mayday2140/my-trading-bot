# -*- coding: utf-8 -*-
import requests, time, json, uuid, base64, os, sys, threading, math, signal
import websocket
from datetime import datetime
from nacl.signing import SigningKey
from nacl.encoding import HexEncoder

# ==========================================
# âš™ï¸ æ ¸å¿ƒé…ç½® (è«‹å¡«å…¥æ‚¨çš„è³‡è¨Š)
# ==========================================
CONFIG = {
    "JWT": "eyJhbGciOiJFUzI1NiIsImtpZCI6IlhnaEJQSVNuN0RQVHlMcWJtLUVHVkVhOU1lMFpwdU9iMk1Qc2gtbUFlencifQ.eyJhIjoiMHhDNmEwYTc4RDI1OTkwYTc4NDQ1REMzNTY1RjExNTY4Yjc3MDkzZTA0IiwiYyI6ImJzYyIsIm4iOiJJc1hYSUk0eWlQbkRmT1dlbyIsImkiOiIyMDI2LTAxLTIwVDAwOjEwOjMwLjA2N1oiLCJzIjoiZHNiMGdmTk9KaVBRL1pGUFZsMmgzblJ4YXFWaTB6MFZKN1FJOHpvNTR2QjNxYVFMMTRlTzl4RDVUOG5QTGZibWNXVHBPZSttZVR0TEp6RTd0Q0hnNHh3PSIsInIiOiI2Y3FhS2g0Z0ViUlA3V3FLNlNvYnF6WHBhc1dHR0RMUnAycHd3S0VQV0pGZiIsInciOjIsImlhdCI6MTc2ODg2NzgzNiwiZXhwIjoxNzY5NDcyNjM2fQ.FWptKbJ0CRYvlfbyxwk3scqtVSk3qRdWlzpUl6nOPT8Dmq2yStNNRrhY_dq5b7T1EdsWZSpWy1jdnNYPva_7zg",
    "SECRET": "ea0abbb377fd2102c8ade8c872a7cc6e1341c5d360f152c50ec9e6b20cbfc852",
    "SYMBOL": "BTC-USD",
    "QTY": "0.05",
    "TARGET_BPS": 8,   # æ›å–®è·é›¢ (è¬åˆ†ä¹‹å…«)
    "MIN_BPS": 7,      # æ’¤å–®æœ€å°é™åº¦ (å¤ªè¿‘å°±æ’¤)
    "MAX_BPS": 10      # æ’¤å–®æœ€å¤§é™åº¦ (å¤ªé å°±æ’¤)
}

# ä¿®æ­£ Windows CMD ç·¨ç¢¼èˆ‡å¤–è§€
if sys.platform == "win32":
    import io
    # å¼·åˆ¶è¨­å®šè¼¸å‡ºç‚º UTF-8 é¿å…ä¸­æ–‡äº‚ç¢¼
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    os.system('color 0a') # è¨­å®š CMD ç‚ºé»‘åº•ç¶ å­— (Matrix é¢¨æ ¼)

# ==========================================
# ğŸ›¡ï¸ æ©Ÿå™¨äººæ ¸å¿ƒé¡åˆ¥
# ==========================================
class StandXCMD:
    def __init__(self):
        self.base_url = "https://perps.standx.com"
        self.ws_url = "wss://perps.standx.com/ws-stream/v1"
        self.mid_price = 0.0
        self.bid = 0.0
        self.ask = 0.0
        self.running = True
        
        # é‡‘é‘°è™•ç† (ç§»é™¤ 0x å‰ç¶´)
        pk = CONFIG["SECRET"][2:] if CONFIG["SECRET"].startswith("0x") else CONFIG["SECRET"]
        self.signer = SigningKey(pk, encoder=HexEncoder)
        self.headers = {"Authorization": f"Bearer {CONFIG['JWT']}", "Content-Type": "application/json"}
        
        # åœ¨å¾Œå°å•Ÿå‹• WebSocket å ±åƒ¹
        self.start_ws()

    def start_ws(self):
        def on_msg(ws, msg):
            d = json.loads(msg).get("data", {})
            if "mid_price" in d:
                self.mid_price = float(d["mid_price"])
                self.bid = float(d["spread"][0])
                self.ask = float(d["spread"][1])

        def run():
            ws = websocket.WebSocketApp(self.ws_url, 
                on_open=lambda ws: ws.send(json.dumps({"subscribe": {"channel": "price", "symbol": CONFIG["SYMBOL"]}})),
                on_message=on_msg)
            ws.run_forever()
        
        t = threading.Thread(target=run, daemon=True)
        t.start()

    def sign(self, body):
        rid = str(uuid.uuid4())
        ts = str(int(time.time() * 1000))
        msg = f"v1,{rid},{ts},{body}"
        sig = base64.b64encode(self.signer.sign(msg.encode()).signature).decode()
        return {"x-request-sign-version": "v1", "x-request-id": rid, "x-request-timestamp": ts, "x-request-signature": sig}

    def call(self, method, path, data=None):
        try:
            url = self.base_url + path
            if method == "GET": 
                return requests.get(url, headers=self.headers, timeout=2).json()
            body = json.dumps(data)
            return requests.post(url, data=body, headers={**self.headers, **self.sign(body)}, timeout=2).json()
        except Exception:
            return {}

    def main_loop(self):
        os.system('cls')
        print(">>> æ­£åœ¨åˆå§‹åŒ– ProcyonsBot äº¤æ˜“ç³»çµ±...")
        
        while self.running:
            try:
                if self.mid_price == 0:
                    time.sleep(0.5); continue

                # 1. å–å¾—ç›®å‰æ›å–®
                res = self.call("GET", f"/api/query_open_orders?symbol={CONFIG['SYMBOL']}")
                orders = res.get('result', [])
                
                has_buy = has_sell = False
                mid = self.mid_price

                # 2. æ’¤å–®é‚è¼¯ (æª¢æŸ¥é»å·®æ˜¯å¦åç§»)
                for o in orders:
                    dist = abs(mid - float(o['price'])) / mid * 10000
                    if dist < CONFIG["MIN_BPS"] or dist > CONFIG["MAX_BPS"]:
                        self.call("POST", "/api/cancel_order", {"order_id": o['id']})
                    else:
                        if o['side'] == 'buy': has_buy = True
                        else: has_sell = True

                # 3. è£œå–®é‚è¼¯
                if not has_buy:
                    p = int(mid * (1 - CONFIG['TARGET_BPS']/10000))
                    self.call("POST", "/api/new_order", {"symbol": CONFIG["SYMBOL"], "side": "buy", "order_type": "limit", "qty": CONFIG["QTY"], "price": str(p)})
                if not has_sell:
                    p = int(mid * (1 + CONFIG['TARGET_BPS']/10000))
                    self.call("POST", "/api/new_order", {"symbol": CONFIG["SYMBOL"], "side": "sell", "order_type": "limit", "qty": CONFIG["QTY"], "price": str(p)})

                # 4. åˆ·æ–°ä»‹é¢
                os.system('cls')
                print(f"====================================================")
                print(f"      STANDX MARKET MAKER - PROCYONS BOT")
                print(f"====================================================")
                print(f" ğŸ•’ ç³»çµ±æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
                print(f" ğŸ’° ä¸­é–“åƒ¹: {mid:,.2f}  | è²·ä¸€: {self.bid:,.1f} | è³£ä¸€: {self.ask:,.1f}")
                print(f" ğŸ“Š è¨‚å–®ç‹€æ…‹: è²·å–® [{'âˆš' if has_buy else ' '}]  è³£å–® [{'âˆš' if has_sell else ' '}]")
                print(f" âš™ï¸  ç•¶å‰é…ç½®: {CONFIG['SYMBOL']} | {CONFIG['QTY']} Qty | {CONFIG['TARGET_BPS']} bps")
                print(f"----------------------------------------------------")
                print(f" [æç¤º] æŒ‰ä¸‹ Ctrl + C å¯å®‰å…¨åœæ­¢ä¸¦æ’¤å–®")
                
                time.sleep(0.5)

            except KeyboardInterrupt:
                print("\n[!] åµæ¸¬åˆ°åœæ­¢è¨Šè™Ÿï¼ŒåŸ·è¡Œå®‰å…¨æ’¤å–®ä¸­...")
                self.running = False
                res = self.call("GET", f"/api/query_open_orders?symbol={CONFIG['SYMBOL']}")
                for o in res.get('result', []):
                    self.call("POST", "/api/cancel_order", {"order_id": o['id']})
                print(">>> è¨‚å–®å·²å…¨éƒ¨æ’¤éŠ·ã€‚")
                break
            except Exception as e:
                print(f"ç³»çµ±ç•°å¸¸: {e}"); time.sleep(1)

if __name__ == "__main__":
    bot = StandXCMD()
    bot.main_loop()